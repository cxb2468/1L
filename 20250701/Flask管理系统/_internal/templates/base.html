<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { min-height: 100vh; }
        .sidebar {
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 220px;
            background: #343a40;
            color: #fff;
            padding-top: 20px;
        }
        .sidebar a { color: #fff; display: block; padding: 10px 20px; }
        .sidebar a.active, .sidebar a:hover { background: #495057; text-decoration: none; }
        .content { margin-left: 220px; padding: 30px; }
        .sidebar .submenu { display: none; margin-left: 18px; }
        .sidebar .menu-group.active .submenu { display: block; }
        .sidebar .menu-title { cursor: pointer; font-weight: bold; padding: 10px 20px; display: flex; align-items: center; }
        .sidebar .menu-title:hover, .sidebar a.active, .sidebar a:hover { background: #495057; text-decoration: none; }
        .sidebar .menu-icon { margin-right: 8px; font-size: 18px; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table {
            white-space: nowrap !important;
        }
        .table th,
        .table td {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table-responsive {
            overflow-x: auto;
            max-height: 70vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„70% */
            overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
        }
        /* å›ºå®šè¡¨å¤´æ ·å¼ */
        .table-responsive thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
            border-bottom: 2px solid #dee2e6;
        }
        /* è¡¨æ ¼è¡Œæ‚¬åœæ•ˆæœ */
        .table-responsive tbody tr:hover {
            background-color: #f5f5f5;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* åˆ†é¡µæ ·å¼ä¼˜åŒ– */
        .pagination .page-link {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            background-color: #fff;
            border-color: #dee2e6;
        }
        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
{% set perms = (current_user.permissions.split(',') if current_user.is_authenticated and current_user.permissions else []) %}
{% set path = request.path %}

<!-- æ™ºèƒ½åˆ†é¡µå® -->
{% macro smart_pagination(pagination, per_page, q='', field='') %}
    {% set current_page = pagination.page %}
    {% set total_pages = pagination.pages %}
    {% set has_prev = pagination.has_prev %}
    {% set has_next = pagination.has_next %}
    {% set prev_num = pagination.prev_num %}
    {% set next_num = pagination.next_num %}
    {% set total = pagination.total %}
    
    {% if total_pages > 1 %}
    <div class="d-flex align-items-center">
        <!-- åˆ†é¡µä¿¡æ¯ -->
        <div class="mr-3 text-muted small">
            ç¬¬ {{ current_page }} é¡µï¼Œå…± {{ total_pages }} é¡µ
            {% if total %}
            ï¼ˆå…± {{ total }} æ¡è®°å½•ï¼‰
            {% endif %}
        </div>
        
        <!-- åˆ†é¡µæŒ‰é’® -->
        <nav>
            <ul class="pagination mb-0">
                <!-- é¦–é¡µ -->
                <li class="page-item {% if not has_prev %}disabled{% endif %}">
                    <a class="page-link" href="?page=1&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">é¦–é¡µ</a>
                </li>
                
                <!-- ä¸Šä¸€é¡µ -->
                <li class="page-item {% if not has_prev %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ prev_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">ä¸Šä¸€é¡µ</a>
                </li>
                
                <!-- é¡µç æŒ‰é’® -->
                {% set start_page = [1, current_page - 2] | max %}
                {% set end_page = [total_pages, current_page + 2] | min %}
                
                <!-- å¦‚æœå¼€å§‹é¡µç ä¸æ˜¯ç¬¬1é¡µï¼Œæ˜¾ç¤ºçœç•¥å· -->
                {% if start_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">1</a>
                    </li>
                    {% if start_page > 2 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endif %}
                
                <!-- æ˜¾ç¤ºå½“å‰é¡µé™„è¿‘çš„é¡µç  -->
                {% for p in range(start_page, end_page + 1) %}
                    <li class="page-item {% if current_page == p %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">{{ p }}</a>
                    </li>
                {% endfor %}
                
                <!-- å¦‚æœç»“æŸé¡µç ä¸æ˜¯æœ€åä¸€é¡µï¼Œæ˜¾ç¤ºçœç•¥å· -->
                {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">{{ total_pages }}</a>
                    </li>
                {% endif %}
                
                <!-- ä¸‹ä¸€é¡µ -->
                <li class="page-item {% if not has_next %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ next_num }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">ä¸‹ä¸€é¡µ</a>
                </li>
                
                <!-- æœ«é¡µ -->
                <li class="page-item {% if not has_next %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}{% if q %}&q={{ q }}{% endif %}{% if field %}&field={{ field }}{% endif %}">æœ«é¡µ</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
{% endmacro %}

<!-- è‡ªå®šä¹‰Jinja2è¿‡æ»¤å™¨ -->
<script>
// åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatBeijingTime(datetimeStr) {
    if (!datetimeStr) return '';
    
    try {
        // å¦‚æœæ˜¯UTCæ—¶é—´ï¼Œè½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
        let dt = new Date(datetimeStr);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯UTCæ—¶é—´ï¼ˆæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼‰
        if (datetimeStr.includes('+00:00') || datetimeStr.endsWith('Z') || 
            (datetimeStr.includes('T') && !datetimeStr.includes('+'))) {
            // UTCæ—¶é—´ï¼ŒåŠ 8å°æ—¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
            dt = new Date(dt.getTime() + 8 * 60 * 60 * 1000);
        }
        
        // æ ¼å¼åŒ–è¾“å‡º
        const year = dt.getFullYear();
        const month = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hours = String(dt.getHours()).padStart(2, '0');
        const minutes = String(dt.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    } catch (e) {
        console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', e);
        return datetimeStr;
    }
}

// é¡µé¢åŠ è½½å®Œæˆåå¤„ç†æ‰€æœ‰æ—¶é—´æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«æ—¶é—´çš„å…ƒç´ 
    const timeElements = document.querySelectorAll('[data-time]');
    timeElements.forEach(function(element) {
        const timeStr = element.getAttribute('data-time');
        if (timeStr) {
            element.textContent = formatBeijingTime(timeStr);
        }
    });
});
</script>

<div class="sidebar">
    <h4 class="text-center">ç®¡ç†ç³»ç»Ÿ</h4>
    {% if current_user.is_authenticated %}
    <a href="/" class="menu-title{% if path == '/' %} active{% endif %}"><span class="menu-icon">ğŸ </span>é¦–é¡µ</a>
    {% endif %}
    {% if current_user.is_authenticated and (current_user.is_admin or 'contract' in perms) %}
    <a href="/contract/" class="menu-title{% if path.startswith('/contract/') %} active{% endif %}"><span class="menu-icon">ğŸ“„</span>åˆåŒç®¡ç†</a>
    {% endif %}
    {% if current_user.is_authenticated and (current_user.is_admin or 'project' in perms) %}
    <a href="/project/" class="menu-title{% if path.startswith('/project/') %} active{% endif %}"><span class="menu-icon">ğŸ“</span>é¡¹ç›®ç®¡ç†</a>
    {% endif %}
    {% if current_user.is_authenticated and (current_user.is_admin or 'staff' in perms) %}
    <a href="/staff/" class="menu-title{% if path.startswith('/staff/') %} active{% endif %}"><span class="menu-icon">ğŸ‘¤</span>äººå‘˜ç®¡ç†</a>
    {% endif %}
    {% if current_user.is_authenticated and current_user.is_admin %}
    <a href="/field/" class="menu-title{% if path.startswith('/field/') %} active{% endif %}"><span class="menu-icon">âš™ï¸</span>å­—æ®µé…ç½®</a>
    <a href="/user/list" class="menu-title{% if path.startswith('/user/') %} active{% endif %}"><span class="menu-icon">ğŸ‘¥</span>ç”¨æˆ·ç®¡ç†</a>
    {% endif %}
    {% if current_user.is_authenticated %}
    <a href="/user/logout" class="menu-title"><span class="menu-icon">ğŸšª</span>é€€å‡ºç™»å½•</a>
    {% endif %}
</div>
<div class="content">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
</div>

<script>
    function toggleMenu(id) {
        var el = document.getElementById(id);
        el.classList.toggle('active');
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var tables = document.querySelectorAll('.table');
    tables.forEach(function(table) {
        var tableId = table.getAttribute('id') || 'table_' + Math.random().toString(36).substr(2, 9);
        table.setAttribute('id', tableId);
        
        var tablesort = new Tablesort(table);
        
        // æ’åºåè‡ªåŠ¨æ›´æ–°åºå·
        table.addEventListener('afterSort', function() {
            var rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row, idx) {
                var firstCell = row.querySelector('td:first-child');
                if(firstCell && firstCell.textContent.trim().match(/^\d+$/)) {
                    firstCell.textContent = idx + 1;
                }
            });
            
            // ä¿å­˜æ’åºçŠ¶æ€åˆ°localStorage
            var sortInfo = {
                column: tablesort.currentSort[0].index,
                direction: tablesort.currentSort[0].direction
            };
            localStorage.setItem('tableSort_' + tableId, JSON.stringify(sortInfo));
        });
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤æ’åºçŠ¶æ€
        var savedSort = localStorage.getItem('tableSort_' + tableId);
        if(savedSort) {
            try {
                var sortInfo = JSON.parse(savedSort);
                var header = table.querySelector('thead th:nth-child(' + (sortInfo.column + 1) + ')');
                if(header) {
                    setTimeout(function() {
                        header.click();
                        if(sortInfo.direction === 'desc') {
                            header.click(); // å†ç‚¹ä¸€æ¬¡å˜æˆé™åº
                        }
                    }, 100);
                }
            } catch(e) {
                console.log('æ¢å¤æ’åºçŠ¶æ€å¤±è´¥:', e);
            }
        }
    });
});
</script>
</body>
</html> 